<?php
include '../includes/cabecalho.php';
require_once '../includes/acl.php';
require_admin();
require_once '../includes/modelo_usuarios.php';

$usuarios = listarUsuariosComBateria();

function rotulo_bat($n) {
    $map = [
        0 => ['üòµ','Esgotado'],
        1 => ['üòü','Baix√≠ssimo'],
        2 => ['üôÅ','Baixo'],
        3 => ['üòê','Neutro'],
        4 => ['üôÇ','Bom'],
        5 => ['ü§©','Cheio'],
    ];
    return $map[$n] ?? ['üòê','Neutro'];
}
?>
<link rel="stylesheet" href="../assets/css/bateria.css">

<h2>Vis√£o Geral ‚Äî Bateria Social</h2>
<p class="help">Apenas administradores veem esta p√°gina.</p>

<table class="tabela" aria-describedby="legend-bateria">
  <colgroup>
    <col class="nome" />
    <col class="email" />
    <col class="tipo" />
    <col class="tema" />
    <col class="bat" />
    <col class="atual" />
  </colgroup>
  <thead>
    <tr>
      <th>Nome</th>
      <th>Email</th>
      <th>Tipo</th>
      <th>Tema</th>
      <th>Bateria</th>
      <th>Atualizado em</th>
    </tr>
  </thead>
  <tbody>
    <?php foreach ($usuarios as $u): 
      $n = isset($u['bateria_social']) ? (int)$u['bateria_social'] : 3;
      [$emoji, $txt] = rotulo_bat($n);
      $quando = $u['bateria_atualizado_em'] ? date('d/m/Y H:i', strtotime($u['bateria_atualizado_em'])) : '‚Äî';
    ?>
    <tr>
      <td><?php echo htmlspecialchars($u['nome'] ?? '', ENT_QUOTES, 'UTF-8'); ?></td>
      <td><?php echo htmlspecialchars($u['email'] ?? '', ENT_QUOTES, 'UTF-8'); ?></td>
      <td><?php echo htmlspecialchars($u['tipo'] ?? '', ENT_QUOTES, 'UTF-8'); ?></td>
      <td><?php echo htmlspecialchars($u['tema_preferido'] ?? '', ENT_QUOTES, 'UTF-8'); ?></td>
      <td>
        <span class="bat-pill lvl-<?php echo $n; ?>">
          <span aria-hidden="true" class="bat-pill__emoji"><?php echo $emoji; ?></span>
          <span class="bat-pill__text"><?php echo $txt; ?></span>
        </span>
      </td>
      <td><?php echo $quando; ?></td>
    </tr>
    <?php endforeach; ?>
  </tbody>
</table>

<p id="legend-bateria" class="help">Legenda: 0=Esgotado ‚Ä¶ 5=Cheio.</p>

<?php include '../includes/rodape.php'; ?>
